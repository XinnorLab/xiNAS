---
# ─── 1. Node.js 20 LTS via NodeSource ─────────────────────────────────────────

- name: Check current Node.js version
  ansible.builtin.command: node --version
  register: _node_ver
  changed_when: false
  failed_when: false
  tags: [xinas_mcp, nodejs]

- name: Install Node.js 20 from NodeSource
  tags: [xinas_mcp, nodejs]
  when: >
    _node_ver.rc != 0 or
    not (_node_ver.stdout | regex_search('^v2[0-9]\.'))
  block:
    - name: Install NodeSource prerequisites
      ansible.builtin.apt:
        name:
          - ca-certificates
          - curl
          - gnupg
        state: present

    - name: Create /etc/apt/keyrings directory
      ansible.builtin.file:
        path: /etc/apt/keyrings
        state: directory
        mode: '0755'

    - name: Import NodeSource GPG key
      ansible.builtin.shell: >
        curl -fsSL https://deb.nodesource.com/gpgkey/nodesource-repo.gpg.key
        | gpg --dearmor -o /etc/apt/keyrings/nodesource.gpg
      args:
        creates: /etc/apt/keyrings/nodesource.gpg

    - name: Add NodeSource APT repository
      ansible.builtin.apt_repository:
        repo: >-
          deb [signed-by=/etc/apt/keyrings/nodesource.gpg]
          https://deb.nodesource.com/node_20.x nodistro main
        state: present
        filename: nodesource

    - name: Install nodejs package
      ansible.builtin.apt:
        name: nodejs
        state: present
        update_cache: true

# ─── 2. Build the MCP server ───────────────────────────────────────────────────

- name: Verify MCP source directory exists
  ansible.builtin.stat:
    path: "{{ xinas_mcp_repo_path }}/package.json"
  register: _mcp_src
  tags: [xinas_mcp, build]

- name: Fail if MCP source not found
  ansible.builtin.fail:
    msg: >
      xiNAS-MCP source not found at {{ xinas_mcp_repo_path }}.
      Ensure the xiNAS repo is cloned to /opt/xiNAS before running this role.
  when: not _mcp_src.stat.exists
  tags: [xinas_mcp, build]

- name: Install npm dependencies
  ansible.builtin.command:
    cmd: npm ci
    chdir: "{{ xinas_mcp_repo_path }}"
  register: _npm_ci
  changed_when: "'added' in _npm_ci.stdout or 'updated' in _npm_ci.stdout"
  tags: [xinas_mcp, build]

- name: Build TypeScript → dist/
  ansible.builtin.command:
    cmd: npm run build
    chdir: "{{ xinas_mcp_repo_path }}"
  changed_when: true
  tags: [xinas_mcp, build]

# ─── 3. NFS helper daemon ──────────────────────────────────────────────────────

- name: Create NFS helper library directory
  ansible.builtin.file:
    path: "{{ xinas_mcp_helper_lib_path }}"
    state: directory
    owner: root
    group: root
    mode: '0755'
  tags: [xinas_mcp, nfs_helper]

- name: Copy NFS helper Python sources
  ansible.builtin.copy:
    src: "{{ xinas_mcp_repo_path }}/nfs-helper/"
    dest: "{{ xinas_mcp_helper_lib_path }}/"
    owner: root
    group: root
    mode: '0644'
    remote_src: true
  notify: restart xinas-nfs-helper
  tags: [xinas_mcp, nfs_helper]

- name: Make nfs_helper.py executable
  ansible.builtin.file:
    path: "{{ xinas_mcp_helper_lib_path }}/nfs_helper.py"
    mode: '0755'
  tags: [xinas_mcp, nfs_helper]

- name: Install xinas-nfs-helper systemd unit
  ansible.builtin.copy:
    src: "{{ xinas_mcp_repo_path }}/nfs-helper/xinas-nfs-helper.service"
    dest: /etc/systemd/system/xinas-nfs-helper.service
    owner: root
    group: root
    mode: '0644'
    remote_src: true
  notify:
    - reload systemd
    - restart xinas-nfs-helper
  tags: [xinas_mcp, nfs_helper]

- name: Force systemd daemon-reload before enabling service
  ansible.builtin.meta: flush_handlers
  tags: [xinas_mcp, nfs_helper]

- name: Enable and start xinas-nfs-helper
  ansible.builtin.service:
    name: xinas-nfs-helper
    enabled: true
    state: started
  tags: [xinas_mcp, nfs_helper, service]

# ─── 4. Directories and configuration ─────────────────────────────────────────

- name: Create MCP config directory
  ansible.builtin.file:
    path: "{{ xinas_mcp_config_dir }}"
    state: directory
    owner: root
    group: root
    mode: '0750'
  tags: [xinas_mcp, config]

- name: Deploy default MCP config (first install only)
  ansible.builtin.template:
    src: xinas-mcp-config.json.j2
    dest: "{{ xinas_mcp_config_dir }}/config.json"
    owner: root
    group: root
    mode: '0640'
    force: false    # never overwrite an existing config (preserves controller_id)
  tags: [xinas_mcp, config]

- name: Create audit log directory
  ansible.builtin.file:
    path: "{{ xinas_mcp_audit_log_path | dirname }}"
    state: directory
    owner: root
    group: root
    mode: '0750'
  tags: [xinas_mcp, config]

# ─── 5. Claude Code MCP integration ───────────────────────────────────────────

- name: Create Claude Code config directory for root
  ansible.builtin.file:
    path: "{{ xinas_mcp_claude_config_dir }}"
    state: directory
    owner: root
    group: root
    mode: '0700'
  when: xinas_mcp_configure_claude
  tags: [xinas_mcp, claude]

- name: Deploy Claude Code MCP servers config (first install only)
  ansible.builtin.template:
    src: claude-mcp-servers.json.j2
    dest: "{{ xinas_mcp_claude_config_dir }}/mcp_servers.json"
    owner: root
    group: root
    mode: '0600'
    force: false    # preserve user-added MCP servers
  when: xinas_mcp_configure_claude
  tags: [xinas_mcp, claude]

# ─── 6. Root SSH access for Claude Code ───────────────────────────────────────

- name: Allow root SSH login via key auth (for Claude Code MCP connection)
  ansible.builtin.copy:
    dest: /etc/ssh/sshd_config.d/10-xinas-root-access.conf
    content: |
      # Managed by xinas_mcp Ansible role
      # Allows key-based root SSH login for Claude Code MCP stdio transport
      # Password root login remains blocked by default Ubuntu policy
      PermitRootLogin prohibit-password
    owner: root
    group: root
    mode: '0644'
  when: xinas_mcp_allow_root_ssh
  notify: restart sshd
  tags: [xinas_mcp, ssh]

- name: Create xinas-mcp wrapper script
  ansible.builtin.copy:
    dest: /usr/local/bin/xinas-mcp
    content: |
      #!/bin/sh
      exec node {{ xinas_mcp_repo_path }}/dist/index.js "$@"
    owner: root
    group: root
    mode: '0755'
  tags: [xinas_mcp, ssh]
