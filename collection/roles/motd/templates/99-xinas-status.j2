#!/bin/bash
# xiNAS Dynamic MOTD - System Status Display
# Deployed by Ansible

# Colors
RED=$'\033[0;31m'
GREEN=$'\033[0;32m'
YELLOW=$'\033[1;33m'
BLUE=$'\033[0;34m'
CYAN=$'\033[0;36m'
WHITE=$'\033[1;37m'
GRAY=$'\033[0;90m'
NC=$'\033[0m'
BOLD=$'\033[1m'

# Box width
W=75

# Draw functions
line() {
    printf "+%${W}s+\n" | tr ' ' '-'
}

header() {
    local title="$1"
    printf "| %-$((W-2))s |\n" "$title"
}

row() {
    printf "| %-$((W-2))s |\n" "$1"
}

empty_row() {
    printf "| %$((W-2))s |\n" ""
}

separator() {
    printf "+%${W}s+\n" | tr ' ' '-'
}

# Progress bar (no colors for alignment)
progress_bar() {
    local percent=$1
    local width=${2:-20}
    local filled=$((percent * width / 100))
    local empty=$((width - filled))
    local bar=""
    for ((i=0; i<filled; i++)); do bar+="#"; done
    for ((i=0; i<empty; i++)); do bar+="."; done
    echo "$bar"
}

echo ""
echo -e "${BLUE}"
cat << 'EOF'
    ██╗  ██╗██╗███╗   ██╗ █████╗ ███████╗
    ╚██╗██╔╝██║████╗  ██║██╔══██╗██╔════╝
     ╚███╔╝ ██║██╔██╗ ██║███████║███████╗
     ██╔██╗ ██║██║╚██╗██║██╔══██║╚════██║
    ██╔╝ ██╗██║██║ ╚████║██║  ██║███████║
    ╚═╝  ╚═╝╚═╝╚═╝  ╚═══╝╚═╝  ╚═╝╚══════╝
EOF
echo -e "${NC}"
echo -e "    ${GREEN}High-Performance NAS Server${NC}"
echo ""

# Gather system info
HOSTNAME=$(hostname -f 2>/dev/null || hostname)
UPTIME=$(uptime -p 2>/dev/null | sed 's/up //')
KERNEL=$(uname -r)

# CPU Info
CPU_CORES=$(nproc)
CPU_IDLE=$(top -bn1 2>/dev/null | grep "Cpu(s)" | awk '{print $8}' | cut -d. -f1)
[[ -z "$CPU_IDLE" ]] && CPU_IDLE=$(awk '/^cpu / {print int($5*100/($2+$3+$4+$5+$6+$7+$8))}' /proc/stat 2>/dev/null)
CPU_USAGE=$((100 - ${CPU_IDLE:-0}))

# Memory
MEM_TOTAL=$(free -b | awk '/^Mem:/ {print $2}')
MEM_USED=$(free -b | awk '/^Mem:/ {print $3}')
MEM_PERCENT=$((MEM_USED * 100 / MEM_TOTAL))
MEM_TOTAL_H=$(free -h | awk '/^Mem:/ {print $2}')
MEM_USED_H=$(free -h | awk '/^Mem:/ {print $3}')

# Load
LOAD=$(cat /proc/loadavg | awk '{print $1" / "$2" / "$3}')

# NFSD
if [[ -f /proc/fs/nfsd/threads ]]; then
    NFSD_THREADS=$(cat /proc/fs/nfsd/threads 2>/dev/null)
    NFSD_STATUS="Running ($NFSD_THREADS threads)"
else
    NFSD_STATUS="Stopped"
fi

# ============== SYSTEM ==============
line
header "SYSTEM"
separator
row "  Hostname:  $HOSTNAME"
row "  Uptime:    $UPTIME"
row "  Kernel:    $KERNEL"
row "  NFS:       $NFSD_STATUS"
line
echo ""

# ============== RESOURCES ==============
line
header "RESOURCES"
separator
CPU_BAR=$(progress_bar $CPU_USAGE 25)
MEM_BAR=$(progress_bar $MEM_PERCENT 25)
row "  CPU:   [$CPU_BAR] ${CPU_USAGE}%  ($CPU_CORES cores)"
row "  MEM:   [$MEM_BAR] ${MEM_PERCENT}%  ($MEM_USED_H / $MEM_TOTAL_H)"
row "  LOAD:  $LOAD (1/5/15 min)"
line
echo ""

# ============== NETWORK ==============
line
header "NETWORK INTERFACES"
separator

net_count=0
for iface in $(ls /sys/class/net/ 2>/dev/null | grep -v '^lo$' | sort); do
    ip_addr=$(ip -4 addr show "$iface" 2>/dev/null | grep -oP '(?<=inet\s)\d+(\.\d+){3}/\d+' | head -1)
    [[ -z "$ip_addr" ]] && ip_addr="No IP"

    speed=$(cat /sys/class/net/"$iface"/speed 2>/dev/null)
    state=$(cat /sys/class/net/"$iface"/operstate 2>/dev/null)

    # Format speed
    if [[ "$speed" =~ ^[0-9]+$ ]] && [[ $speed -gt 0 ]]; then
        if [[ $speed -ge 1000 ]]; then
            speed_str="$((speed/1000))Gb/s"
        else
            speed_str="${speed}Mb/s"
        fi
    else
        speed_str="---"
    fi

    # State indicator
    if [[ "$state" == "up" ]]; then
        state_icon="[UP]"
    else
        state_icon="[DN]"
    fi

    printf "| %-73s |\n" "  $state_icon $(printf '%-12s' $iface) $(printf '%-20s' $ip_addr) $speed_str"
    ((net_count++))
done

[[ $net_count -eq 0 ]] && row "  No network interfaces"
line
echo ""

# ============== RAID ==============
line
header "RAID ARRAYS"
separator

if command -v xicli &> /dev/null; then
    raid_tmp=$(mktemp)
    xicli raid show -f json > "$raid_tmp" 2>/dev/null
    if [[ -s "$raid_tmp" ]]; then
        python3 << PYEOF > "${raid_tmp}.out"
import json
try:
    with open('$raid_tmp') as f:
        data = json.load(f)
    if not data:
        print('NONE||')
    else:
        arrays = data.values() if isinstance(data, dict) else data
        for arr in arrays:
            name = arr.get('name', 'unknown')
            level = arr.get('level', '?')
            state_val = arr.get('state')
            if isinstance(state_val, list) and len(state_val) > 0 and state_val[0]:
                state = str(state_val[0])
            elif state_val and not isinstance(state_val, list):
                state = str(state_val)
            else:
                state = 'inactive'
            size_val = arr.get('size', 0)
            if isinstance(size_val, str):
                size_str = ' '.join(size_val.split())
            elif size_val:
                if size_val >= 1099511627776:
                    size_str = f'{size_val/1099511627776:.1f} TB'
                else:
                    size_str = f'{size_val/1073741824:.1f} GB'
            else:
                size_str = 'N/A'
            if state.lower() in ['online', 'optimal', 'active', 'initialized']:
                icon = '[OK]'
            elif state.lower() in ['degraded', 'rebuilding', 'initing']:
                icon = '[!!]'
            else:
                icon = '[--]'
            print(f'{icon}|{name}|RAID{level}|{size_str}|{state}')
except Exception as e:
    print(f'ERR|{e}|')
PYEOF
        while IFS='|' read -r icon name level size state; do
            if [[ "$icon" == "NONE" ]]; then
                row "  No RAID arrays configured"
            elif [[ "$icon" == "ERR" ]]; then
                row "  Error reading RAID: $name"
            elif [[ -n "$icon" ]]; then
                printf "| %-73s |\n" "  $icon $(printf '%-12s' "$name") $(printf '%-8s' "$level") $(printf '%-12s' "$size") $state"
            fi
        done < "${raid_tmp}.out"
        rm -f "$raid_tmp" "${raid_tmp}.out"
    else
        row "  No RAID arrays configured"
        rm -f "$raid_tmp"
    fi
else
    row "  xiRAID not installed"
fi
line
echo ""

# ============== NFS SHARES ==============
line
header "NFS SHARES"
separator

share_count=0
if [[ -f /etc/exports ]]; then
    while IFS= read -r exp_line; do
        [[ "$exp_line" =~ ^[[:space:]]*# ]] && continue
        [[ -z "${exp_line// }" ]] && continue

        share_path=$(echo "$exp_line" | awk '{print $1}')
        [[ -z "$share_path" ]] && continue

        if [[ -d "$share_path" ]]; then
            disk_info=$(df -h "$share_path" 2>/dev/null | awk 'NR==2 {print $3"/"$2" ("$5")"}')
            [[ -z "$disk_info" ]] && disk_info="N/A"
            printf "| %-73s |\n" "  [OK] $(printf '%-30s' $share_path) $disk_info"
        else
            printf "| %-73s |\n" "  [!!] $(printf '%-30s' $share_path) not mounted"
        fi
        ((share_count++))
    done < /etc/exports
fi

[[ $share_count -eq 0 ]] && row "  No NFS shares configured"
line
echo ""

# ============== ACTIVE CLIENTS ==============
line
header "ACTIVE NFS CLIENTS"
separator

client_count=0
if [[ -d /proc/fs/nfsd/clients ]]; then
    for client_dir in /proc/fs/nfsd/clients/*/; do
        [[ -f "${client_dir}info" ]] || continue
        client_ip=$(grep -oP 'address:\s*\K[\d.]+' "${client_dir}info" 2>/dev/null | head -1)
        [[ -n "$client_ip" ]] && {
            row "  [*] $client_ip"
            ((client_count++))
        }
    done
fi

if [[ $client_count -eq 0 ]]; then
    nfs_clients=$(ss -tn state established '( dport = :2049 )' 2>/dev/null | awk 'NR>1 {split($4,a,":"); print a[1]}' | sort -u)
    for client_ip in $nfs_clients; do
        [[ -n "$client_ip" ]] && {
            row "  [*] $client_ip"
            ((client_count++))
        }
    done
fi

[[ $client_count -eq 0 ]] && row "  No active clients"
line
echo ""

# Footer
TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
echo "  Last updated: $TIMESTAMP"
echo "  Run 'xinas-menu' for management options"
echo ""
