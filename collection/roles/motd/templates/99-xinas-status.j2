#!/bin/bash
# xiNAS Dynamic MOTD - System Status Display
# Deployed by Ansible

# Colors
RED=$'\033[0;31m'
GREEN=$'\033[0;32m'
YELLOW=$'\033[1;33m'
BLUE=$'\033[0;34m'
CYAN=$'\033[0;36m'
WHITE=$'\033[1;37m'
GRAY=$'\033[0;90m'
NC=$'\033[0m'
BOLD=$'\033[1m'

# Box width
W=75

# Icons
ICON_OK="${GREEN}‚óè${NC}"
ICON_WARN="${YELLOW}‚óè${NC}"
ICON_ERR="${RED}‚óè${NC}"
ICON_INFO="${CYAN}‚óè${NC}"
ICON_UP="${GREEN}‚ñ≤${NC}"
ICON_DOWN="${RED}‚ñº${NC}"

# Draw functions
line() {
    echo -e "${CYAN}+$(printf '%*s' $W '' | tr ' ' '-')+${NC}"
}

header() {
    local title="$1"
    echo -e "${CYAN}|${NC} ${BOLD}${WHITE}$title${NC}$(printf '%*s' $((W - ${#title} - 2)) '')${CYAN}|${NC}"
}

row() {
    printf "| %-$((W-2))s |\n" "$1"
}

row_color() {
    echo -e "${CYAN}|${NC} $1$(printf '%*s' $((W - 3)) '')${CYAN}|${NC}"
}

empty_row() {
    echo -e "${CYAN}|${NC}$(printf '%*s' $((W)) '')${CYAN}|${NC}"
}

separator() {
    echo -e "${CYAN}+$(printf '%*s' $W '' | tr ' ' '-')+${NC}"
}

# Progress bar with color
progress_bar() {
    local percent=$1
    local width=${2:-20}
    local filled=$((percent * width / 100))
    local empty=$((width - filled))
    local color
    if [[ $percent -ge 90 ]]; then
        color="$RED"
    elif [[ $percent -ge 70 ]]; then
        color="$YELLOW"
    else
        color="$GREEN"
    fi
    local bar="${color}"
    for ((i=0; i<filled; i++)); do bar+="‚ñà"; done
    bar+="${GRAY}"
    for ((i=0; i<empty; i++)); do bar+="‚ñë"; done
    bar+="${NC}"
    echo -e "$bar"
}

echo ""
echo -e "${BLUE}"
cat << 'EOF'
    ‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïó‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó
    ‚ïö‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù
     ‚ïö‚ñà‚ñà‚ñà‚ïî‚ïù ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó
     ‚ñà‚ñà‚ïî‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïë‚ïö‚ïê‚ïê‚ïê‚ïê‚ñà‚ñà‚ïë
    ‚ñà‚ñà‚ïî‚ïù ‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë ‚ïö‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë
    ‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
EOF
echo -e "${NC}"
echo -e "    ${GREEN}High-Performance NAS Server${NC}"
echo ""

# Gather system info
HOSTNAME=$(hostname -f 2>/dev/null || hostname)
UPTIME=$(uptime -p 2>/dev/null | sed 's/up //')
KERNEL=$(uname -r)

# CPU Info
CPU_CORES=$(nproc)
CPU_IDLE=$(top -bn1 2>/dev/null | grep "Cpu(s)" | awk '{print $8}' | cut -d. -f1)
[[ -z "$CPU_IDLE" ]] && CPU_IDLE=$(awk '/^cpu / {print int($5*100/($2+$3+$4+$5+$6+$7+$8))}' /proc/stat 2>/dev/null)
CPU_USAGE=$((100 - ${CPU_IDLE:-0}))

# Memory
MEM_TOTAL=$(free -b | awk '/^Mem:/ {print $2}')
MEM_USED=$(free -b | awk '/^Mem:/ {print $3}')
MEM_PERCENT=$((MEM_USED * 100 / MEM_TOTAL))
MEM_TOTAL_H=$(free -h | awk '/^Mem:/ {print $2}')
MEM_USED_H=$(free -h | awk '/^Mem:/ {print $3}')

# Load
LOAD=$(cat /proc/loadavg | awk '{print $1" / "$2" / "$3}')

# NFSD
if [[ -f /proc/fs/nfsd/threads ]]; then
    NFSD_THREADS=$(cat /proc/fs/nfsd/threads 2>/dev/null)
    NFSD_STATUS="Running ($NFSD_THREADS threads)"
else
    NFSD_STATUS="Stopped"
fi

# ============== SYSTEM ==============
line
header "üìä SYSTEM"
separator
echo -e "${CYAN}|${NC}   ${WHITE}Hostname:${NC}  ${GREEN}$HOSTNAME${NC}$(printf '%*s' $((W - ${#HOSTNAME} - 14)) '')${CYAN}|${NC}"
echo -e "${CYAN}|${NC}   ${WHITE}Uptime:${NC}    ${YELLOW}$UPTIME${NC}$(printf '%*s' $((W - ${#UPTIME} - 14)) '')${CYAN}|${NC}"
echo -e "${CYAN}|${NC}   ${WHITE}Kernel:${NC}    $KERNEL$(printf '%*s' $((W - ${#KERNEL} - 14)) '')${CYAN}|${NC}"
if [[ "$NFSD_STATUS" == "Stopped" ]]; then
    echo -e "${CYAN}|${NC}   ${WHITE}NFS:${NC}       ${RED}$NFSD_STATUS${NC}$(printf '%*s' $((W - ${#NFSD_STATUS} - 11)) '')${CYAN}|${NC}"
else
    echo -e "${CYAN}|${NC}   ${WHITE}NFS:${NC}       ${GREEN}$NFSD_STATUS${NC}$(printf '%*s' $((W - ${#NFSD_STATUS} - 11)) '')${CYAN}|${NC}"
fi
line
echo ""

# ============== RESOURCES ==============
line
header "üíª RESOURCES"
separator
CPU_BAR=$(progress_bar $CPU_USAGE 25)
MEM_BAR=$(progress_bar $MEM_PERCENT 25)
echo -e "${CYAN}|${NC}   ${WHITE}CPU:${NC}   [${CPU_BAR}] ${CPU_USAGE}%  ${GRAY}($CPU_CORES cores)${NC}       ${CYAN}|${NC}"
echo -e "${CYAN}|${NC}   ${WHITE}MEM:${NC}   [${MEM_BAR}] ${MEM_PERCENT}%  ${GRAY}($MEM_USED_H / $MEM_TOTAL_H)${NC}  ${CYAN}|${NC}"
echo -e "${CYAN}|${NC}   ${WHITE}LOAD:${NC}  $LOAD ${GRAY}(1/5/15 min)${NC}                        ${CYAN}|${NC}"
line
echo ""

# ============== NETWORK ==============
line
header "üåê NETWORK INTERFACES"
separator

net_count=0
for iface in $(ls /sys/class/net/ 2>/dev/null | grep -v '^lo$' | sort); do
    ip_addr=$(ip -4 addr show "$iface" 2>/dev/null | grep -oP '(?<=inet\s)\d+(\.\d+){3}/\d+' | head -1)
    [[ -z "$ip_addr" ]] && ip_addr="No IP"

    speed=$(cat /sys/class/net/"$iface"/speed 2>/dev/null)
    state=$(cat /sys/class/net/"$iface"/operstate 2>/dev/null)

    # Format speed
    if [[ "$speed" =~ ^[0-9]+$ ]] && [[ $speed -gt 0 ]]; then
        if [[ $speed -ge 1000 ]]; then
            speed_str="${GREEN}$((speed/1000))Gb/s${NC}"
        else
            speed_str="${YELLOW}${speed}Mb/s${NC}"
        fi
    else
        speed_str="${GRAY}---${NC}"
    fi

    # State indicator
    if [[ "$state" == "up" ]]; then
        state_icon="${GREEN}‚ñ≤${NC}"
        state_color="$GREEN"
    else
        state_icon="${RED}‚ñº${NC}"
        state_color="$RED"
    fi

    echo -e "${CYAN}|${NC}   ${state_icon} ${WHITE}$(printf '%-12s' $iface)${NC} ${YELLOW}$(printf '%-20s' $ip_addr)${NC} ${speed_str}             ${CYAN}|${NC}"
    ((net_count++))
done

[[ $net_count -eq 0 ]] && echo -e "${CYAN}|${NC}   ${GRAY}No network interfaces${NC}                                                 ${CYAN}|${NC}"
line
echo ""

# ============== RAID ==============
line
header "üíæ RAID ARRAYS"
separator

if command -v xicli &> /dev/null; then
    raid_tmp=$(mktemp)
    xicli raid show -f json > "$raid_tmp" 2>/dev/null
    if [[ -s "$raid_tmp" ]]; then
        python3 << PYEOF > "${raid_tmp}.out"
import json
try:
    with open('$raid_tmp') as f:
        data = json.load(f)
    if not data:
        print('NONE||')
    else:
        arrays = data.values() if isinstance(data, dict) else data
        for arr in arrays:
            name = arr.get('name', 'unknown')
            level = arr.get('level', '?')
            state_val = arr.get('state')
            if isinstance(state_val, list) and len(state_val) > 0 and state_val[0]:
                state = str(state_val[0])
            elif state_val and not isinstance(state_val, list):
                state = str(state_val)
            else:
                state = 'inactive'
            size_val = arr.get('size', 0)
            if isinstance(size_val, str):
                size_str = ' '.join(size_val.split())
            elif size_val:
                if size_val >= 1099511627776:
                    size_str = f'{size_val/1099511627776:.1f} TB'
                else:
                    size_str = f'{size_val/1073741824:.1f} GB'
            else:
                size_str = 'N/A'
            if state.lower() in ['online', 'optimal', 'active', 'initialized']:
                icon = 'OK'
            elif state.lower() in ['degraded', 'rebuilding', 'initing']:
                icon = 'WARN'
            else:
                icon = 'ERR'
            print(f'{icon}|{name}|RAID{level}|{size_str}|{state}')
except Exception as e:
    print(f'ERROR|{e}|')
PYEOF
        while IFS='|' read -r icon name level size state; do
            if [[ "$icon" == "NONE" ]]; then
                echo -e "${CYAN}|${NC}   ${GRAY}No RAID arrays configured${NC}                                             ${CYAN}|${NC}"
            elif [[ "$icon" == "ERROR" ]]; then
                echo -e "${CYAN}|${NC}   ${RED}‚óè${NC} Error reading RAID: $name                                       ${CYAN}|${NC}"
            elif [[ -n "$icon" ]]; then
                if [[ "$icon" == "OK" ]]; then
                    status_icon="${GREEN}‚óè${NC}"
                    state_color="$GREEN"
                elif [[ "$icon" == "WARN" ]]; then
                    status_icon="${YELLOW}‚óè${NC}"
                    state_color="$YELLOW"
                else
                    status_icon="${RED}‚óè${NC}"
                    state_color="$RED"
                fi
                echo -e "${CYAN}|${NC}   ${status_icon} ${WHITE}$(printf '%-12s' "$name")${NC} ${CYAN}$(printf '%-8s' "$level")${NC} ${YELLOW}$(printf '%-12s' "$size")${NC} ${state_color}$state${NC}     ${CYAN}|${NC}"
            fi
        done < "${raid_tmp}.out"
        rm -f "$raid_tmp" "${raid_tmp}.out"
    else
        echo -e "${CYAN}|${NC}   ${GRAY}No RAID arrays configured${NC}                                             ${CYAN}|${NC}"
        rm -f "$raid_tmp"
    fi
else
    echo -e "${CYAN}|${NC}   ${GRAY}xiRAID not installed${NC}                                                  ${CYAN}|${NC}"
fi
line
echo ""

# ============== NFS SHARES ==============
line
header "üìÅ NFS SHARES"
separator

share_count=0
if [[ -f /etc/exports ]]; then
    while IFS= read -r exp_line; do
        [[ "$exp_line" =~ ^[[:space:]]*# ]] && continue
        [[ -z "${exp_line// }" ]] && continue

        share_path=$(echo "$exp_line" | awk '{print $1}')
        [[ -z "$share_path" ]] && continue

        if [[ -d "$share_path" ]]; then
            disk_info=$(df -h "$share_path" 2>/dev/null | awk 'NR==2 {print $3"/"$2" ("$5")"}')
            [[ -z "$disk_info" ]] && disk_info="N/A"
            echo -e "${CYAN}|${NC}   ${GREEN}‚óè${NC} ${WHITE}$(printf '%-30s' $share_path)${NC} ${YELLOW}$disk_info${NC}           ${CYAN}|${NC}"
        else
            echo -e "${CYAN}|${NC}   ${RED}‚óè${NC} ${WHITE}$(printf '%-30s' $share_path)${NC} ${RED}not mounted${NC}              ${CYAN}|${NC}"
        fi
        ((share_count++))
    done < /etc/exports
fi

[[ $share_count -eq 0 ]] && echo -e "${CYAN}|${NC}   ${GRAY}No NFS shares configured${NC}                                              ${CYAN}|${NC}"
line
echo ""

# ============== ACTIVE CLIENTS ==============
line
header "üë• ACTIVE NFS CLIENTS"
separator

client_count=0
if [[ -d /proc/fs/nfsd/clients ]]; then
    for client_dir in /proc/fs/nfsd/clients/*/; do
        [[ -f "${client_dir}info" ]] || continue
        client_ip=$(grep -oP 'address:\s*\K[\d.]+' "${client_dir}info" 2>/dev/null | head -1)
        [[ -n "$client_ip" ]] && {
            echo -e "${CYAN}|${NC}   ${GREEN}‚óè${NC} ${WHITE}$client_ip${NC}                                                        ${CYAN}|${NC}"
            ((client_count++))
        }
    done
fi

if [[ $client_count -eq 0 ]]; then
    nfs_clients=$(ss -tn state established '( dport = :2049 )' 2>/dev/null | awk 'NR>1 {split($4,a,":"); print a[1]}' | sort -u)
    for client_ip in $nfs_clients; do
        [[ -n "$client_ip" ]] && {
            echo -e "${CYAN}|${NC}   ${GREEN}‚óè${NC} ${WHITE}$client_ip${NC}                                                        ${CYAN}|${NC}"
            ((client_count++))
        }
    done
fi

[[ $client_count -eq 0 ]] && echo -e "${CYAN}|${NC}   ${GRAY}No active clients${NC}                                                     ${CYAN}|${NC}"
line
echo ""

# Footer
TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
echo -e "  ${GRAY}Last updated: ${WHITE}$TIMESTAMP${NC}"
echo -e "  ${GRAY}Run '${CYAN}xinas-menu${GRAY}' for management options${NC}"
echo ""
