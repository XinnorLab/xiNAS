---
- name: Download xiraid_exporter archive
  ansible.builtin.get_url:
    url: "{{ xiraid_exporter_download_url }}"
    dest: "/tmp/xiraid_exporter_{{ xiraid_exporter_version }}.tar.gz"
    mode: '0644'
    force: no
  tags: [xiraid_exporter, download]

- name: Extract xiraid_exporter binary
  ansible.builtin.unarchive:
    src: "/tmp/xiraid_exporter_{{ xiraid_exporter_version }}.tar.gz"
    dest: "/tmp"
    remote_src: yes
    creates: "/tmp/xiraid_exporter_v{{ xiraid_exporter_version }}_{{ xiraid_exporter_arch }}"
  tags: [xiraid_exporter, install]

- name: Install xiraid_exporter binary
  ansible.builtin.copy:
    src: "/tmp/xiraid_exporter_v{{ xiraid_exporter_version }}_{{ xiraid_exporter_arch }}/xiraid_exporter"
    dest: "{{ xiraid_exporter_install_dir }}/xiraid_exporter"
    mode: '0755'
  tags: [xiraid_exporter, install]

- name: Ensure openssl package present
  ansible.builtin.apt:
    name: openssl
    state: present
  tags: [xiraid_exporter, cert]

- name: Create xiRAID certificate directory
  ansible.builtin.file:
    path: /etc/xraid/crt
    state: directory
    owner: root
    group: root
    mode: '0755'
  tags: [xiraid_exporter, cert]

- name: Generate xiRAID CA key
  ansible.builtin.command: openssl genrsa -out ca.key 2048
  args:
    chdir: /etc/xraid/crt
    creates: ca.key
  tags: [xiraid_exporter, cert]

- name: Generate xiRAID CA certificate
  ansible.builtin.command: >-
    openssl req -new -x509 -days 365 -key ca.key
    -subj '/C=US/ST=State/L=City/O=Company/OU=IT/CN=CA'
    -out ca-cert.crt
  args:
    chdir: /etc/xraid/crt
    creates: ca-cert.crt
  tags: [xiraid_exporter, cert]

- name: Generate xiRAID server key and CSR
  ansible.builtin.command: >-
    openssl req -newkey rsa:2048 -nodes -keyout server-key.key
    -subj '/C=US/ST=State/L=City/O=Company/OU=IT/CN=localhost'
    -out server-cert.csr
  args:
    chdir: /etc/xraid/crt
    creates: server-cert.csr
  tags: [xiraid_exporter, cert]

- name: Generate xiRAID server certificate
  ansible.builtin.shell: >-
    openssl x509 -req -extfile <(printf 'subjectAltName=DNS:localhost,IP:127.0.0.1')
    -days 365 -in server-cert.csr -CA ca-cert.crt -CAkey ca.key -CAcreateserial
    -out server-cert.crt
  args:
    executable: /bin/bash
    chdir: /etc/xraid/crt
    creates: server-cert.crt
  notify: restart xiraid
  tags: [xiraid_exporter, cert]

- name: Install systemd service unit
  ansible.builtin.template:
    src: xiraid_exporter.service.j2
    dest: /etc/systemd/system/xiraid_exporter.service
    mode: '0644'
  notify: reload xiraid_exporter
  tags: [xiraid_exporter, service]

- name: Enable and start xiraid_exporter service
  ansible.builtin.service:
    name: xiraid_exporter
    enabled: true
    state: started
  tags: [xiraid_exporter, service]
