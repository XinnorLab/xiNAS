#!/bin/bash
# Ansible-managed: Apply lossless Ethernet settings for RoCE
# Generated by roce_lossless role

set -euo pipefail

LOG_TAG="roce-lossless"

log_info() {
    logger -t "$LOG_TAG" -p user.info "$1"
    echo "[INFO] $1"
}

log_error() {
    logger -t "$LOG_TAG" -p user.err "$1"
    echo "[ERROR] $1" >&2
}

# Wait for interfaces to be ready
sleep 2

{% for iface in roce_detected_interfaces %}
# Configure {{ iface }}
if [ -d "/sys/class/net/{{ iface }}" ]; then
    log_info "Configuring {{ iface }}..."

    # DCB mode
    mlnx_qos -i {{ iface }} --dcbx_mode=firmware 2>/dev/null || true

    # PFC
    mlnx_qos -i {{ iface }} --pfc {{ roce_pfc_string | trim }} || log_error "Failed to set PFC on {{ iface }}"

    # ETS bandwidth
    mlnx_qos -i {{ iface }} --tc_bw {{ roce_ets_tc_bw }} || log_error "Failed to set ETS on {{ iface }}"

    # Trust mode
    mlnx_qos -i {{ iface }} --trust={{ roce_trust_mode }} 2>/dev/null || true

    # DSCP mapping
    mlnx_qos -i {{ iface }} --dscp2prio set,{{ roce_dscp }},{{ roce_pfc_priority }} 2>/dev/null || true

    # PCP mapping
    mlnx_qos -i {{ iface }} --pcp2prio {{ roce_pcp }},{{ roce_pfc_priority }} 2>/dev/null || true

{% if roce_ecn_enabled %}
    # ECN
    mlnx_qos -i {{ iface }} --ecn={{ roce_traffic_class }},on 2>/dev/null || true
{% endif %}

    log_info "{{ iface }} configured successfully"
else
    log_error "Interface {{ iface }} not found"
fi

{% endfor %}
{% if roce_cma_tos | int >= 0 %}
# Set RDMA CM ToS
sysctl -w net.rdma_cm.default_roce_tos={{ roce_cma_tos }} || true
{% endif %}

log_info "RoCE lossless configuration complete"
exit 0
