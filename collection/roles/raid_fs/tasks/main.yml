---
- name: Gather existing xiRAID arrays (json)
  ansible.builtin.command: xicli raid show -f json
  register: xiraid_list
  changed_when: false
  failed_when: xiraid_list.rc != 0
  tags: [raid_fs, raid]

- name: Set fact â€“ parsed arrays
  ansible.builtin.set_fact:
    existing_arrays: "{{ xiraid_list.stdout | from_json }}"
  tags: [raid_fs, raid]

- name: Create xiRAID arrays that are missing
  ansible.builtin.include_tasks: create_array.yml
  loop: "{{ xiraid_arrays }}"
  loop_control:
    loop_var: item
  when: item.name not in existing_arrays | json_query('[].name')
  tags: [raid_fs, raid]

# ----------------------- Filesystem section -------------------
- name: Ensure XFS utils present
  ansible.builtin.apt:
    name: xfsprogs
    state: present
  tags: [raid_fs, fs]

- name: Create XFS filesystems if absent
  ansible.builtin.include_tasks: create_fs.yml
  loop: "{{ xfs_filesystems }}"
  loop_control:
    loop_var: item
  tags: [raid_fs, fs]
