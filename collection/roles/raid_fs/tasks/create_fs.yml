- name: Query filesystem type on {{ item.data_device }}
  ansible.builtin.command: blkid -s TYPE -o value {{ item.data_device }}
  register: blkid_type
  failed_when: false
  changed_when: false

- name: Query filesystem label on {{ item.data_device }}
  ansible.builtin.command: blkid -s LABEL -o value {{ item.data_device }}
  register: blkid_label
  failed_when: false
  changed_when: false

# Calculate XFS geometry from RAID array if not explicitly provided
- name: Find data array for geometry calculation
  ansible.builtin.set_fact:
    _data_array: "{{ xiraid_arrays | selectattr('name', 'equalto', 'data') | first | default({}) }}"
  when: item.su_kb is not defined or item.sw is not defined

- name: Calculate XFS geometry from data array
  ansible.builtin.set_fact:
    _fs_su_kb: "{{ item.su_kb | default(_data_array.strip_size_kb | default(128)) }}"
    _fs_sw: "{{ item.sw | default((_data_array.devices | default([]) | length) - (_data_array.parity_disks | default(1) | int)) }}"
  when: item.su_kb is not defined or item.sw is not defined

- name: Use explicit XFS geometry
  ansible.builtin.set_fact:
    _fs_su_kb: "{{ item.su_kb }}"
    _fs_sw: "{{ item.sw }}"
  when: item.su_kb is defined and item.sw is defined

- name: Check if {{ item.data_device }} is currently mounted
  ansible.builtin.command: findmnt -n -o TARGET {{ item.data_device }}
  register: _current_mount
  failed_when: false
  changed_when: false
  tags: [raid_fs, fs, mkfs]

- name: Unmount {{ item.data_device }} before mkfs
  ansible.builtin.command: umount {{ item.data_device }}
  when:
    - _current_mount.rc == 0
    - _current_mount.stdout | length > 0
    - (xfs_force_mkfs | default(false) | bool) or blkid_type.stdout != 'xfs' or blkid_label.stdout != item.label
  tags: [raid_fs, fs, mkfs]

- name: Get log device size in bytes for {{ item.log_device }}
  ansible.builtin.command: blockdev --getsize64 {{ item.log_device }}
  register: _log_dev_bytes
  changed_when: false
  when: (xfs_force_mkfs | default(false) | bool) or blkid_type.stdout != 'xfs' or blkid_label.stdout != item.label
  tags: [raid_fs, fs, mkfs]

- name: Calculate effective log size for {{ item.label }}
  ansible.builtin.set_fact:
    _effective_log_size: >-
      {{ (item.log_size | human_to_bytes | int > _log_dev_bytes.stdout | int)
         | ternary(_log_dev_bytes.stdout | int | string, item.log_size) }}
  when: (xfs_force_mkfs | default(false) | bool) or blkid_type.stdout != 'xfs' or blkid_label.stdout != item.label
  tags: [raid_fs, fs, mkfs]

- name: Make filesystem {{ item.label }} on {{ item.data_device }}
  ansible.builtin.command: >-
    mkfs.xfs -f -L {{ item.label }} -d su={{ _fs_su_kb }}k,sw={{ _fs_sw }}
    -l logdev={{ item.log_device }},size={{ _effective_log_size }}
    -s size={{ item.sector_size }} {{ item.data_device }}
  when: (xfs_force_mkfs | default(false) | bool) or blkid_type.stdout != 'xfs' or blkid_label.stdout != item.label
  tags: [raid_fs, fs, mkfs]

- name: Wait for block devices to settle
  ansible.builtin.command: udevadm settle
  changed_when: false
  tags: [raid_fs, fs, mkfs]

- name: Create mountpoint {{ item.mountpoint }}
  ansible.builtin.file:
    path: "{{ item.mountpoint }}"
    state: directory
    mode: '0755'
  tags: [raid_fs, fs]

- name: Compute mount unit parameters for {{ item.label }}
  ansible.builtin.set_fact:
    block_device_unit: >-
      {{ item.data_device | regex_replace('^/','') | replace('/', '-') }}.device
    log_device_unit: >-
      {{ item.log_device | regex_replace('^/','') | replace('/', '-') }}.device
    unit_opts: >-
      {{ 'defaults' + (',' + item.mount_opts if (item.mount_opts | default('') | length > 0) else '') }}
    mount_unit: >-
      {{ item.mountpoint | regex_replace('^/','') | replace('/', '-') }}.mount
  tags: [raid_fs, fs]

- name: Deploy systemd mount unit for {{ item.label }}
  ansible.builtin.template:
    src: mount.unit.j2
    dest: "/etc/systemd/system/{{ mount_unit }}"
    mode: '0644'
  notify: reload systemd
  tags: [raid_fs, fs]

- name: Reload systemd before enabling mount unit
  meta: flush_handlers

- name: Enable and start mount unit for {{ item.label }}
  ansible.builtin.systemd:
    name: "{{ mount_unit }}"
    enabled: true
    state: started
  tags: [raid_fs, fs]
