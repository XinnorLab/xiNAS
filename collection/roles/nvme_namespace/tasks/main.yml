---
# Main entry point for nvme_namespace role
#
# This role detects non-system drives, optionally rebuilds NVMe namespaces,
# and generates RAID configuration for the raid_fs role.
#
# Two detection modes:
#   "nvme" (default) - NVMe controllers only, creates n1/n2 namespaces
#   "all"            - All block devices (VMs), uses whole drives directly

- name: Check if automatic namespace management is enabled
  ansible.builtin.debug:
    msg: |
      Automatic namespace management is DISABLED.
      Set nvme_auto_namespace: true to enable.
      Using manual RAID configuration from presets.
  when: not nvme_auto_namespace | bool

# ═══════════════════════════════════════════════════════════════════════════════
# Mode: "all" - Detect all block devices (VMs with virtio/SCSI drives)
# Uses whole drives directly, no namespace management
# ═══════════════════════════════════════════════════════════════════════════════

- name: Run all-drive detection (VM mode)
  when:
    - nvme_auto_namespace | bool
    - nvme_detect_mode | default('nvme') == 'all'
  block:
    - name: Detect all non-OS block devices
      ansible.builtin.include_tasks: detect_all_drives.yml

    - name: Abort if system drive not found
      ansible.builtin.fail:
        msg: |
          CRITICAL: Could not detect system drive.
          Aborting to prevent accidental data loss on the OS drive.
          If this is intentional, set nvme_abort_if_no_system_drive: false
      when:
        - nvme_abort_if_no_system_drive | bool
        - nvme_system_drives is not defined or nvme_system_drives | length == 0

    - name: Check for available data drives
      ansible.builtin.debug:
        msg: |
          No data drives found. All detected drives appear to be system drives.
      when: nvme_data_drives | length == 0

    - name: Cleanup existing storage configurations
      ansible.builtin.include_tasks: cleanup_storage.yml
      when:
        - nvme_data_drives | length > 0
        - nvme_cleanup_existing_storage | default(true) | bool

    - name: Generate RAID configuration
      ansible.builtin.include_tasks: generate_raid_config.yml
      when:
        - nvme_data_drives | length > 0
        - nvme_small_ns_devices is defined
        - nvme_large_ns_devices is defined
        - nvme_small_ns_devices | length > 0
        - nvme_large_ns_devices | length > 0

    - name: Display final summary (VM mode)
      ansible.builtin.debug:
        msg: |
          ============ Drive Detection Complete (VM Mode) ============
          System drives (protected): {{ nvme_system_drives | join(', ') }}
          Data drives found: {{ nvme_data_drives | length }}

          Drive assignment:
            Log drives (first {{ nvme_log_drive_count }}): {{ nvme_small_ns_devices | default([]) | join(', ') }}
            Data drives (remaining): {{ nvme_large_ns_devices | default([]) | join(', ') }}

          RAID configuration generated for raid_fs role:
            Data array: RAID {{ nvme_raid_data_level }} with {{ nvme_large_ns_devices | default([]) | length }} devices
            Log array: RAID {{ nvme_raid_log_level }} with {{ nvme_small_ns_devices | default([]) | length }} devices
          ===========================================================
      when: nvme_data_drives | length > 0

# ═══════════════════════════════════════════════════════════════════════════════
# Mode: "nvme" - NVMe controller detection with namespace management (default)
# ═══════════════════════════════════════════════════════════════════════════════

- name: Run NVMe namespace management
  when:
    - nvme_auto_namespace | bool
    - nvme_detect_mode | default('nvme') == 'nvme'
  block:
    # Phase 1: Detect system and data drives
    - name: Detect system and data drives
      ansible.builtin.include_tasks: detect_drives.yml

    # Phase 2: Cleanup existing storage (LVM, MD, ZFS) on data drives
    - name: Cleanup existing storage configurations
      ansible.builtin.include_tasks: cleanup_storage.yml
      when:
        - nvme_data_drives | length > 0
        - nvme_cleanup_existing_storage | default(true) | bool

    # Phase 3: Abort if system drive not found (safety check)
    - name: Abort if system drive not found
      ansible.builtin.fail:
        msg: |
          CRITICAL: Could not detect system drive.
          Aborting to prevent accidental data loss on the OS drive.
          If this is intentional, set nvme_abort_if_no_system_drive: false
      when:
        - nvme_abort_if_no_system_drive | bool
        - nvme_system_drives is not defined or nvme_system_drives | length == 0

    # Phase 4: Check if there are any data drives to process
    - name: Check for available data drives
      ansible.builtin.debug:
        msg: |
          No NVMe data drives found for namespace operations.
          All detected NVMe drives appear to be system drives.
      when: nvme_data_drives | length == 0

    # Phase 5: Either use existing namespaces or rebuild them
    - name: Use existing namespaces (skip rebuild)
      ansible.builtin.include_tasks: detect_existing_namespaces.yml
      when:
        - nvme_data_drives | length > 0
        - nvme_use_existing_namespaces | bool

    - name: Collect NVMe topology for namespace rebuild
      ansible.builtin.include_tasks: collect_topology.yml
      when:
        - nvme_data_drives | length > 0
        - not (nvme_use_existing_namespaces | bool)

    # Phase 6: Rebuild namespaces (only if not using existing)
    - name: Rebuild namespaces on data drives
      ansible.builtin.include_tasks: rebuild_namespaces.yml
      when:
        - nvme_data_drives | length > 0
        - not (nvme_use_existing_namespaces | bool)

    # Phase 7: Generate RAID configuration (only if namespaces were created)
    - name: Generate RAID configuration
      ansible.builtin.include_tasks: generate_raid_config.yml
      when:
        - nvme_data_drives | length > 0
        - nvme_small_ns_devices is defined
        - nvme_large_ns_devices is defined
        - nvme_small_ns_devices | length > 0
        - nvme_large_ns_devices | length > 0

    # Phase 8: Summary report
    - name: Display final summary
      ansible.builtin.debug:
        msg: |
          ============ NVMe Namespace Management Complete ============
          System drives (protected): {{ nvme_system_drives | join(', ') }}
          Data drives processed: {{ nvme_data_drives | length }}

          Namespace creation:
            Small namespaces (n1, {{ nvme_small_ns_size_mb }}MB): {{ nvme_small_ns_devices | default([]) | length }}
            Large namespaces (n2, remaining): {{ nvme_large_ns_devices | default([]) | length }}

          {% if nvme_failed_devices | default([]) | length > 0 %}
          FAILED DEVICES: {{ nvme_failed_devices | join(', ') }}
          {% endif %}

          RAID configuration generated for raid_fs role:
            Data array: RAID {{ nvme_raid_data_level }} with {{ nvme_large_ns_devices | default([]) | length }} devices
            Log array: RAID {{ nvme_raid_log_level }} with {{ nvme_small_ns_devices | default([]) | length }} devices
          ===========================================================
      when: nvme_data_drives | length > 0
