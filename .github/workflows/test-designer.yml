name: Test Designer

on:
  pull_request:
    types: [opened, synchronize]

permissions:
  pull-requests: write
  contents: read

jobs:
  test-design:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install publishing dependencies
        run: cd scripts && npm ci

      - name: Compute diff
        id: diff
        run: |
          DIFF=$(git diff ${{ github.event.pull_request.base.sha }}...${{ github.event.pull_request.head.sha }})
          echo "$DIFF" > /tmp/pr-diff.txt
          echo "files_changed=$(echo "$DIFF" | grep -c '^diff --git' || true)" >> $GITHUB_OUTPUT

      - name: Read skill methodology
        run: cat .claude/skills/test-designer/SKILL.md > /tmp/skill-methodology.md

      - name: Generate test design via Claude API
        id: generate
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          DIFF=$(cat /tmp/pr-diff.txt)
          SKILL=$(cat /tmp/skill-methodology.md)

          RESPONSE=$(curl -s https://api.anthropic.com/v1/messages \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -H "anthropic-version: 2023-06-01" \
            -H "content-type: application/json" \
            -d "$(jq -n \
              --arg skill "$SKILL" \
              --arg diff "$DIFF" \
              --arg pr "${{ github.event.pull_request.number }}" \
              --arg title "${{ github.event.pull_request.title }}" \
              '{
                model: "claude-sonnet-4-5-20250514",
                max_tokens: 8192,
                messages: [{
                  role: "user",
                  content: ("<skill>\n" + $skill + "\n</skill>\n\nAnalyze this PR and design test coverage.\n\nPR #" + $pr + ": " + $title + "\n\n<diff>\n" + $diff + "\n</diff>\n\nFollow the skill instructions. Output ONLY the JSON block tagged test-designer-json. No markdown output needed.")
                }]
              }'
            )")

          echo "$RESPONSE" | jq -r '.content[0].text' | \
            sed -n '/```test-designer-json/,/```/p' | \
            sed '1d;$d' > /tmp/test-design.json

          jq . /tmp/test-design.json > /dev/null 2>&1 || {
            echo "Error: Claude output was not valid JSON"
            echo "$RESPONSE" | jq -r '.content[0].text'
            exit 1
          }

          echo "json_file=/tmp/test-design.json" >> $GITHUB_OUTPUT

      - name: Publish to TestQuality
        if: success()
        env:
          TQ_ACCESS_TOKEN: ${{ secrets.TQ_ACCESS_TOKEN }}
        run: |
          node scripts/tq-publish.mjs \
            --input /tmp/test-design.json \
            --pr ${{ github.event.pull_request.number }} \
            --project xiNAS

      - name: Post PR comment
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const data = JSON.parse(fs.readFileSync('/tmp/test-design.json', 'utf-8'));
            const plan = data.testPlan;
            const cases = data.testCases;

            const byPriority = { P0: 0, P1: 0, P2: 0 };
            cases.forEach(tc => { byPriority[tc.priority] = (byPriority[tc.priority] || 0) + 1; });
            const components = [...new Set(cases.map(tc => tc.component))];

            const body = [
              '## Test Design Summary',
              '',
              `**Test Plan:** ${plan.title}`,
              `**Test Cases:** ${cases.length} (${byPriority.P0} P0, ${byPriority.P1} P1, ${byPriority.P2} P2)`,
              `**Components:** ${components.join(', ')}`,
              '',
              '### Key Risks',
              ...(plan.risks || []).map(r => `- **${r.severity}:** ${r.description}`),
              '',
              '### Test Strategy',
              `Types: ${(plan.strategy || []).join(', ')}`,
              '',
              '<details>',
              '<summary>Test Cases</summary>',
              '',
              '| ID | Title | Priority | Type | Component |',
              '|----|-------|----------|------|-----------|',
              ...cases.map(tc => `| ${tc.id} | ${tc.title} | ${tc.priority} | ${tc.type} | ${tc.component} |`),
              '',
              '</details>',
              '',
              '---',
              '*Generated by [Test Designer](https://github.com/XinnorLab/xiNAS/blob/main/.claude/skills/test-designer/SKILL.md) skill*',
            ].join('\n');

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            const existing = comments.find(c => c.body.includes('## Test Design Summary'));

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
            }
